{% extends "base.html" %}

{% block title %}{{ g.t['view'] if g.t is defined else 'Game Details' }}{% endblock %}

{% block content %}
<div class="container mt-4 mb-4">
    {% if game.team %}
    <div class="mb-2"><span class="badge bg-info text-dark fs-6">{{ game.team }}</span></div>
    {% endif %}

    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h1 class="mb-2 mb-md-0" style="font-size:1.2rem;">{{ game.home_team }} vs {{ game.away_team }}</h1>
            <div class="result-summary bg-light border rounded px-3 py-2 ms-md-3" style="min-width: 320px;">
                {% set periods = ['1', '2', '3', 'OT'] %}
                {% set home_total = namespace(val=0) %}
                {% set away_total = namespace(val=0) %}
                {% set period_results = [] %}
                {% for p in periods %}
                {% set h = game.result[p]['home'] %}
                {% set a = game.result[p]['away'] %}
                {% set _ = period_results.append((('P' ~ p) if p != 'OT' else 'OT') ~ ':' ~ h ~ '-' ~ a) %}
                {% set home_total.val = home_total.val + h %}
                {% set away_total.val = away_total.val + a %}
                {% endfor %}
                <div class="fs-5 fw-bold text-center mb-1">
                    <span class="text-primary">{{ home_total.val }}</span>
                    <span class="mx-1">:</span>
                    <span class="text-danger">{{ away_total.val }}</span>
                </div>
                <div class="text-center small text-muted">({{ period_results | join(' | ') }})</div>
            </div>
        </div>
    </div>

    <div class="mb-3 d-flex justify-content-between flex-wrap gap-2">
        <div class="d-flex gap-2 flex-wrap">
            {% if request.args.get('edit') != '1' %}
            <a href="{{ url_for('game_details', game_id=game_id, edit=1) }}" class="btn btn-secondary">
                <i class="bi bi-toggle-on"></i> {{ g.t.get('edit_mode', 'Edit Mode') }}
            </a>
            <a href="{{ url_for('view_game_lineup', game_id=game_id) }}" class="btn btn-primary" target="_blank">
                ðŸ“‹ {{ g.t.get('view_lineup', 'View Lineup') }}
            </a>
            {% else %}
            <a href="{{ url_for('game_details', game_id=game_id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-toggle-off"></i> Exit Edit Mode
            </a>
            {% endif %}
            <button type="button" class="btn btn-outline-primary" id="toggleNicknames">
                <i class="bi bi-person-badge"></i> <span id="nicknameToggleText">Show Nicknames</span>
            </button>
        </div>
        {% if request.args.get('edit') != '1' %}
        <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('modify_game', game_id=game_id) }}" class="btn btn-info">
                <i class="bi bi-pencil-square"></i> {{ g.t.get('modify_game', 'Modify Game') }}
            </a>
            <a href="{{ url_for('edit_game_json', game_id=game_id) }}" class="btn btn-warning">
                <i class="bi bi-code-square"></i> {{ g.t.get('edit_json', 'Edit JSON') }}
            </a>
            <a href="#" class="btn btn-danger reset-game-link" data-reset-url="/reset_game/{{ game_id }}">
                <i class="bi bi-arrow-counterclockwise"></i> {{ g.t.get('reset_stats', 'Reset Stats') }}
            </a>
        </div>
        {% endif %}
    </div>

    {% if request.args.get('edit') == '1' %}
    <div class="mb-2">
        <div class="d-flex align-items-center gap-2">
            <span class="fw-bold">{{ 'Period:' }}</span>
            {% for p in ['1', '2', '3', 'OT'] %}
            {% if game.current_period == p %}
            <span class="btn btn-primary btn-sm">{{ 'OT' if p == 'OT' else 'Period ' ~ p }}</span>
            {% else %}
            <a href="/set_period/{{ game_id }}/{{ p }}{% if request.args.get('edit') == '1' %}?edit=1{% endif %}"
                class="btn btn-outline-primary btn-sm">{{ 'OT' if p == 'OT' else 'Period ' ~ p }}</a>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <div class="alert alert-info mb-3" role="alert">
        <strong>{{ g.t.get('plusminus_rules_title', 'Plus/Minus Rules') }}:</strong> {{ g.t.get('plusminus_rules_text', 'A player gets +1 for each even-strength or shorthanded goal their team scores while on the ice, and -1 for each such goal by the opposing team. Power-play goals and penalty shots do not affect plus/minus. Goalies do not have a plus/minus rating.') }}
    </div>
    {% endif %}

    <div class="table-responsive-sm mb-4 mx-lg-5">
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>{{ g.t['line'] }}</th>
                    <th>{{ g.t['player'] }}</th>
                    <th class="text-center">{{ g.t['plusminus'] }}</th>
                    <th class="text-center">{{ g.t['goals'] }}</th>
                    <th class="text-center">{{ g.t['assists'] }}</th>
                    <th class="text-center">{{ g.t['errors'] }}</th>
                    <th class="text-center" title="{{ g.t.get('game_score_full', 'Game Score') }}">{{ g.t.get('game_score', 'GS') }}</th>
                    <th class="actions-col d-none">{{ g.t['actions'] }}</th>
                </tr>
            </thead>
            <tbody>
                {% for line in game.lines %}
                {% set line_idx = loop.index0 %}
                {% for player in line %}
                <tr>
                    {% if loop.index0 == 0 %}
                    <td rowspan="{{ line|length }}" class="align-middle">
                        <div class="d-flex flex-column gap-2">
                            <span>{{ g.t['line'] }} {{ line_idx + 1 }}</span>
                            <a href="/action_line/{{ game_id }}/{{ line_idx }}?action=plus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                class="btn btn-success btn-sm mb-1 line-action d-none">{{ g.t['plus_all'] }}</a>
                            <a href="/action_line/{{ game_id }}/{{ line_idx }}?action=minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                class="btn btn-danger btn-sm mb-1 line-action d-none">{{ g.t['minus_all'] }}</a>
                        </div>
                    </td>
                    {% endif %}
                    <td>
                        <span class="player-name" 
                              data-fullname="{{ player }}" 
                              data-nickname="{{ player_nicknames.get(player, player) }}">
                            {{ player }}
                        </span>
                    </td>
                    {% set pm = game.plusminus[player] if game.plusminus and player in game.plusminus else 0 %}
                    {% set goals = game.goals[player] if game.goals and player in game.goals else 0 %}
                    {% set assists = game.assists[player] if game.assists and player in game.assists else 0 %}
                    {% set errors = game.unforced_errors[player] if game.unforced_errors and player in game.unforced_errors else 0 %}
                    <td class="text-center"><span class="fw-bold">{{ pm }}</span></td>
                    <td class="text-center"><span class="fw-bold">{{ goals }}</span></td>
                    <td class="text-center"><span class="fw-bold">{{ assists }}</span></td>
                    <td class="text-center"><span class="fw-bold">{{ errors }}</span></td>
                    <td class="text-center">
                        {% set gs = (1.5 * goals) + (1.0 * assists) + (0.3 * pm) - (0.2 * errors) %}
                        <span class="fw-bold">{{ "%.1f"|format(gs) }}</span>
                    </td>
                    <td class="actions-col d-none">
                        <div class="dropdown text-center action-dropdown d-none">
                            <button class="btn btn-secondary btn-sm dropdown-toggle w-100" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">{{ g.t['actions'] }}</button>
                            <div class="dropdown-menu p-2 text-center"
                                style="min-width: 140px; overflow: visible; max-height: none;">
                                <a href="/action/{{ game_id }}/{{ player }}?action=plus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-success btn-sm my-1">+1</a>
                                <a href="/action/{{ game_id }}/{{ player }}?action=minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-danger btn-sm my-1">-1</a>
                                <hr class="dropdown-divider">
                                <a href="/action/{{ game_id }}/{{ player }}?action=goal{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-primary btn-sm my-1">{{ g.t['goal'] }}</a>
                                <a href="/action/{{ game_id }}/{{ player }}?action=goal_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-outline-primary btn-sm my-1">-{{ g.t['goal'] }}</a>
                                <hr class="dropdown-divider">
                                <a href="/action/{{ game_id }}/{{ player }}?action=assist{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn_info btn-sm my-1">{{ g.t['assists'] }}</a>
                                <a href="/action/{{ game_id }}/{{ player }}?action=assist_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-outline-info btn-sm my-1">-{{ g.t['assists'] }}</a>
                                <hr class="dropdown-divider">
                                <a href="/action/{{ game_id }}/{{ player }}?action=unforced_error{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-warning btn-sm my-1">{{ g.t['errors'] }}</a>
                                <a href="/action/{{ game_id }}/{{ player }}?action=unforced_error_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-outline-warning btn-sm my-1">-{{ g.t['errors'] }}</a>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h3 class="mb-3">{{ g.t['goalies'] }}</h3>
    <div class="table-responsive-sm mx-lg-5">
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>{{ g.t['goalie'] if g.t is defined else 'Goalie' }}</th>
                    <th class="text-center">{{ g.t['assists'] }}</th>
                    <th class="text-center">{{ g.t['saves'] }}</th>
                    <th class="text-center">{{ g.t['goals_conceded'] }}</th>
                    <th class="text-center">{{ g.t['save_percent'] }}</th>
                    <th colspan="8" class="actions-col d-none">{{ g.t['actions'] }}</th>
                </tr>
            </thead>
            <tbody>
                {% for goalie in game.goalies %}
                <tr>
                    <td>
                        <span class="player-name" 
                              data-fullname="{{ goalie }}" 
                              data-nickname="{{ player_nicknames.get(goalie, goalie) }}">
                            {{ goalie }}
                        </span>
                    </td>
                    <td class="text-center"><span class="fw-bold">{{ game.assists[goalie] if game.assists and goalie in
                            game.assists else 0 }}</span></td>
                    <td class="text-center"><span class="fw-bold">{{ game.saves[goalie] if game.saves and goalie in
                            game.saves else 0 }}</span></td>
                    {% set saves = game.saves[goalie] if game.saves and goalie in game.saves else 0 %}
                    {% set gc = game.goals_conceded[goalie] if game.goals_conceded and goalie in game.goals_conceded else 0 %}
                    {# FALLBACK: If goals_conceded is 0 but goalie has saves, infer from game result #}
                    {% if gc == 0 and saves > 0 and game.result %}
                        {% set away_goals = namespace(total=0) %}
                        {% for period, scores in game.result.items() %}
                            {% set away_goals.total = away_goals.total + (scores.away if scores.away else 0) %}
                        {% endfor %}
                        {% if away_goals.total > 0 %}
                            {% set gc = away_goals.total %}
                        {% endif %}
                    {% endif %}
                    <td class="text-center"><span class="fw-bold">{{ gc }}</span></td>
                    <td class="text-center">
                        {% set total = saves + gc %}
                        {% if total > 0 %}
                        <span class="fw-bold">{{ ((saves / total) * 100) | round(1) }}%</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td colspan="8" class="actions-col d-none">
                        <div class="dropdown dropup text-center goalie-action-dropdown d-none">
                            <button class="btn btn-secondary btn-sm dropdown-toggle w-100" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">{{ g.t['actions'] }}</button>
                            <div class="dropdown-menu dropdown-menu-end p-2 text-center"
                                style="min-width: 140px; overflow: visible; max-height: none;">
                                <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=assist{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-info btn-sm my-1">{{ '+' ~ g.t['assists'] }}</a>
                                <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=assist_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-outline-info btn-sm my-1">{{ '-' ~ g.t['assists'] }}</a>
                                <hr class="dropdown-divider">
                                <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=save{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-primary btn-sm my-1">{{ g.t['save'] }}</a>
                                <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=save_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-outline-primary btn-sm my-1">{{ '-' ~ g.t['save'] }}</a>
                                <hr class="dropdown-divider">
                                <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=goal_conceded{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-danger btn-sm my-1">{{ g.t['goals_conceded'] }}</a>
                                <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=goal_conceded_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-outline-danger btn-sm my-1">{{ '-' ~ g.t['goals_conceded']
                                    }}</a>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h3 class="mb-3">{{ g.t['opponent_goalie'] }}</h3>
    <div class="table-responsive-sm mx-lg-5">
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>{{ g.t['opponent_goalie'] }}</th>
                    <th class="text-center">{{ g.t['saves'] }}</th>
                    <th class="text-center">{{ g.t['goals_conceded'] }}</th>
                    <th class="text-center">{{ g.t['save_percent'] }}</th>
                    <th colspan="4" class="actions-col d-none">{{ g.t['actions'] }}</th>
                </tr>
            </thead>
            <tbody>
                {% if game.opponent_goalie_enabled %}
                <tr>
                    <td>{{ g.t['opponent_goalie'] }}</td>
                    <td class="text-center"><span class="fw-bold">{{ game.opponent_goalie_saves["Opponent Goalie"] if
                            game.opponent_goalie_saves and "Opponent Goalie" in game.opponent_goalie_saves else 0
                            }}</span></td>
                    <td class="text-center"><span id="opponent-goalie-goals" class="fw-bold">{{
                            game.opponent_goalie_goals_conceded["Opponent Goalie"] if
                            game.opponent_goalie_goals_conceded and "Opponent Goalie" in
                            game.opponent_goalie_goals_conceded else 0 }}</span></td>
                    <td class="text-center">
                        {% set saves = game.opponent_goalie_saves["Opponent Goalie"] if game.opponent_goalie_saves and
                        "Opponent Goalie" in game.opponent_goalie_saves else 0 %}
                        {% set gc = game.opponent_goalie_goals_conceded["Opponent Goalie"] if
                        game.opponent_goalie_goals_conceded and "Opponent Goalie" in game.opponent_goalie_goals_conceded
                        else 0 %}
                        {% set total = saves + gc %}
                        {% if total > 0 %}
                        <span class="fw-bold">{{ ((saves / total) * 100) | round(1) }}%</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td colspan="4" class="actions-col d-none">
                        <div class="dropdown dropup text-center opponent-goalie-action-dropdown d-none">
                            <button class="btn btn-secondary btn-sm dropdown-toggle w-100" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">{{ g.t['actions'] }}</button>
                            <div class="dropdown-menu dropdown-menu-end p-2 text-center"
                                style="min-width: 140px; overflow: visible; max-height: none;">
                                <a href="/action_opponent_goalie/{{ game_id }}?action=save{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-primary btn-sm my-1">{{ g.t['save'] }}</a>
                                <a href="/action_opponent_goalie/{{ game_id }}?action=save_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-outline-primary btn-sm my-1">-{{ g.t['save'] }}</a>
                                <hr class="dropdown-divider">
                                <a href="/action_opponent_goalie/{{ game_id }}?action=goal_conceded{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-danger btn-sm my-1">{{ g.t['goals_conceded'] }}</a>
                                <a href="/action_opponent_goalie/{{ game_id }}?action=goal_conceded_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-outline-danger btn-sm my-1">-{{ g.t['goals_conceded'] }}</a>
                            </div>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted">{{ g.t['opponent_goalie_not_enabled'] }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // On page load, check for ?edit=1 and show edit mode if present
    document.addEventListener('DOMContentLoaded', function () {
        if (new URLSearchParams(window.location.search).get('edit') === '1') {
            setEditMode(true);
        }
        // Attach navbar edit link behavior if present
        const navbarEditLink = document.getElementById('navbar-edit-mode-link');
        if (navbarEditLink) {
            navbarEditLink.addEventListener('click', function (e) {
                e.preventDefault();
                // toggle the ?edit param and reload
                toggleModify(e);
            });
        }
    });
    function setEditMode(on) {
        document.querySelectorAll('.action-dropdown').forEach(el => el.classList.toggle('d-none', !on));
        document.querySelectorAll('.line-action').forEach(el => el.classList.toggle('d-none', !on));
        document.querySelectorAll('.goalie-action-dropdown').forEach(el => el.classList.toggle('d-none', !on));
        document.querySelectorAll('.opponent-goalie-action-dropdown').forEach(el => el.classList.toggle('d-none', !on));
        document.querySelectorAll('.actions-col').forEach(el => el.classList.toggle('d-none', !on));
    }
    function toggleModify(e) {
        e.preventDefault();
        const params = new URLSearchParams(window.location.search);
        if (params.get('edit') === '1') {
            params.delete('edit');
        } else {
            params.set('edit', '1');
        }
        // Preserve hash/other params by setting search only
        window.location.search = params.toString();
    }

    // Prevent dropdowns inside horizontally-scrollable tables from being clipped
    function initTableDropdownPopper() {
        // For dropdowns inside a scrollable table, move the menu into document.body
        // when opening so it won't be clipped by ancestor overflow rules, and
        // restore it when closed. Also ensure Popper prevents overflow against body.
        document.querySelectorAll('.table-responsive-sm .dropdown').forEach(function (dd) {
            var toggle = dd.querySelector('.dropdown-toggle');
            var menu = dd.querySelector('.dropdown-menu');
            if (!toggle || !menu) return;

            // Re-initialize the dropdown with popper modifiers that reference body
            try {
                new bootstrap.Dropdown(toggle, {
                    popperConfig: function (defaultBsPopperConfig) {
                        var cfg = defaultBsPopperConfig || {};
                        cfg.modifiers = (cfg.modifiers || []).concat([
                            { name: 'computeStyles', options: { adaptive: false } },
                            { name: 'preventOverflow', options: { boundary: document.body, altAxis: true } },
                            { name: 'flip', options: { fallbackPlacements: ['top', 'bottom'] } }
                        ]);
                        return cfg;
                    }
                });
            } catch (err) {
                console && console.warn && console.warn('Dropdown popper init failed', err);
            }

            // Move menu to body on show so it's not clipped by overflow parents
            dd.addEventListener('show.bs.dropdown', function () {
                try {
                    if (!menu.__origParent) {
                        menu.__origParent = menu.parentNode;
                        menu.__nextSibling = menu.nextSibling;
                        document.body.appendChild(menu);
                    }
                } catch (e) {
                    console && console.warn && console.warn('move menu to body failed', e);
                }
            });

            // Restore menu to original location on hide
            dd.addEventListener('hidden.bs.dropdown', function () {
                try {
                    if (menu.__origParent) {
                        if (menu.__nextSibling) menu.__origParent.insertBefore(menu, menu.__nextSibling);
                        else menu.__origParent.appendChild(menu);
                        delete menu.__origParent;
                        delete menu.__nextSibling;
                    }
                } catch (e) {
                    console && console.warn && console.warn('restore menu failed', e);
                }
            });
        });
    }

    // Also initialize on DOM ready (and when toggling edit mode we keep behavior)
    document.addEventListener('DOMContentLoaded', function () {
        initTableDropdownPopper();
    });

    // Nickname toggle functionality
    let showingNicknames = false;
    const toggleBtn = document.getElementById('toggleNicknames');
    const toggleText = document.getElementById('nicknameToggleText');
    
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            showingNicknames = !showingNicknames;
            
            // Update all player names
            document.querySelectorAll('.player-name').forEach(function(elem) {
                if (showingNicknames) {
                    elem.textContent = elem.getAttribute('data-nickname');
                } else {
                    elem.textContent = elem.getAttribute('data-fullname');
                }
            });
            
            // Update button text
            if (showingNicknames) {
                toggleText.textContent = 'Show Full Names';
                toggleBtn.classList.remove('btn-outline-primary');
                toggleBtn.classList.add('btn-primary');
            } else {
                toggleText.textContent = 'Show Nicknames';
                toggleBtn.classList.remove('btn-primary');
                toggleBtn.classList.add('btn-outline-primary');
            }
        });
    }
</script>
{% endblock %}