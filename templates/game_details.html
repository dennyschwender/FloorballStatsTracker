<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        .table-responsive {
            overflow: visible !important;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Details</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body>
    <div class="container mt-4 mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <a href="/" class="btn btn-secondary btn-sm me-2 mb-2">Back to Home</a>
            <button id="toggle-modify" class="btn btn-warning btn-sm mb-2" onclick="toggleModify(event)">Edit</button>
            <a href="/modify_game/{{ game_id }}" class="btn btn-info btn-sm mb-2 ms-2">Modify Game</a>
            <a href="/reset_game/{{ game_id }}" class="btn btn-danger btn-sm mb-2 ms-2"
                onclick="return confirm('Are you sure you want to reset all stats for this game?');">Reset Stats</a>
        </div>
        {% if games and games|length > 1 %}
        {% set filtered_games = games | selectattr('team', 'equalto', game.team) | list %}
        {% if filtered_games|length > 1 %}
        <form method="get" action="/game/" class="mb-2">
            <select class="form-select" id="game_id" name="game_id"
                onchange="if(this.value) window.location.href='/game/' + this.value;">
                {% for g in filtered_games %}
                <option value="{{ loop.index0 }}" {% if games.index(g)==game_id %}selected{% endif %}>{{ g.home_team }}
                    vs
                    {{ g.away_team }}</option>
                {% endfor %}
            </select>
        </form>
        {% endif %}
        {% endif %}

        {% if game.team %}
        <div class="mb-2"><span class="badge bg-info text-dark fs-6">{{ game.team }}</span></div>
        {% endif %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0" style="font-size:1.2rem;">{{ game.home_team }} vs {{ game.away_team }}</h1>
            <div class="result-summary bg-light border rounded px-3 py-2 ms-3" style="min-width: 320px;">
                {% set periods = ['1', '2', '3', 'OT'] %}
                {% set home_total = namespace(val=0) %}
                {% set away_total = namespace(val=0) %}
                {% set period_results = [] %}
                {% for p in periods %}
                {% set h = game.result[p]['home'] %}
                {% set a = game.result[p]['away'] %}
                {% set _ = period_results.append((('P' ~ p) if p != 'OT' else 'OT') ~ ':' ~ h ~ '-' ~ a) %}
                {% set home_total.val = home_total.val + h %}
                {% set away_total.val = away_total.val + a %}
                {% endfor %}
                <div class="fs-5 fw-bold text-center mb-1">
                    <span class="text-primary">{{ home_total.val }}</span>
                    <span class="mx-1">:</span>
                    <span class="text-danger">{{ away_total.val }}</span>
                </div>
                <div class="text-center small text-muted">
                    ({{ period_results | join(' | ') }})
                </div>
            </div>
        </div>
        {% if request.args.get('edit') == '1' %}
        <div class="mb-2">
            <div class="d-flex align-items-center gap-2">
                <span class="fw-bold">Period:</span>
                {% for p in ['1', '2', '3', 'OT'] %}
                {% if game.current_period == p %}
                <span class="btn btn-primary btn-sm">{{ 'OT' if p == 'OT' else 'Period ' ~ p }}</span>
                {% else %}
                <a href="/set_period/{{ game_id }}/{{ p }}{% if request.args.get('edit') == '1' %}?edit=1{% endif %}"
                    class="btn btn-outline-primary btn-sm">{{ 'OT' if p == 'OT' else 'Period ' ~ p }}</a>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="table-responsive mb-4 mx-lg-5">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Line</th>
                        <th>Player</th>
                        <th class="text-center">+/-</th>
                        <th class="text-center">Goals</th>
                        <th class="text-center">Assists</th>
                        <th class="actions-col d-none">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for line in game.lines %}
                    {% set line_idx = loop.index0 %}
                    {% for player in line %}
                    <tr>
                        {% if loop.index0 == 0 %}
                        <td rowspan="{{ line|length }}" class="align-middle">
                            <div class="d-flex flex-column gap-2">
                                <span>Line {{ line_idx + 1 }}</span>
                                <a href="/action_line/{{ game_id }}/{{ line_idx }}?action=plus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-success btn-sm mb-1 line-action d-none">+1 All</a>
                                <a href="/action_line/{{ game_id }}/{{ line_idx }}?action=minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                    class="btn btn-danger btn-sm mb-1 line-action d-none">-1 All</a>
                            </div>
                        </td>
                        {% endif %}
                        <td>{{ player }}</td>
                        <td class="text-center"><span class="fw-bold">{{ game.plusminus[player] if game.plusminus and
                                player in game.plusminus else 0 }}</span></td>
                        <td class="text-center"><span class="fw-bold">{{ game.goals[player] if game.goals and player in
                                game.goals else 0 }}</span></td>
                        <td class="text-center"><span class="fw-bold">{{ game.assists[player] if game.assists and player
                                in game.assists else 0 }}</span></td>
                        <td class="actions-col d-none">
                            <div class="dropdown text-center action-dropdown d-none">
                                <button class="btn btn-secondary btn-sm dropdown-toggle w-100" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Actions
                                </button>
                                <div class="dropdown-menu p-2 text-center w-100"
                                    style="min-width: 140px; overflow: visible; max-height: none;">
                                    <a href="/action/{{ game_id }}/{{ player }}?action=plus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-success btn-sm my-1 w-100">+1</a>
                                    <a href="/action/{{ game_id }}/{{ player }}?action=minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-danger btn-sm my-1 w-100">-1</a>
                                    <hr class="dropdown-divider">
                                    <a href="/action/{{ game_id }}/{{ player }}?action=goal{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-primary btn-sm my-1 w-100">Goal</a>
                                    <a href="/action/{{ game_id }}/{{ player }}?action=goal_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-outline-primary btn-sm my-1 w-100">-Goal</a>
                                    <hr class="dropdown-divider">
                                    <a href="/action/{{ game_id }}/{{ player }}?action=assist{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-info btn-sm my-1 w-100">Assist</a>
                                    <a href="/action/{{ game_id }}/{{ player }}?action=assist_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-outline-info btn-sm my-1 w-100">-Assist</a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h3 class="mb-3">Goalies</h3>
        <div class="table-responsive mx-lg-5">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Goalie</th>
                        <th class="text-center">Assists</th>
                        <th class="text-center">Saves</th>
                        <th class="text-center">Goals Conceded</th>
                        <th class="text-center">Save %</th>
                        <th colspan="8" class="actions-col d-none">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for goalie in game.goalies %}
                    <tr>
                        <td><span class="badge bg-secondary">{{ goalie }}</span></td>
                        <td class="text-center"><span class="fw-bold">{{ game.assists[goalie] if game.assists and goalie
                                in game.assists else 0 }}</span></td>
                        <td class="text-center"><span class="fw-bold">{{ game.saves[goalie] if game.saves and goalie in
                                game.saves else 0 }}</span></td>
                        <td class="text-center"><span class="fw-bold">{{ game.goals_conceded[goalie] if
                                game.goals_conceded and goalie in game.goals_conceded else 0 }}</span></td>
                        <td class="text-center">
                            {% set saves = game.saves[goalie] if game.saves and goalie in game.saves else 0 %}
                            {% set gc = game.goals_conceded[goalie] if game.goals_conceded and goalie in
                            game.goals_conceded else 0 %}
                            {% set total = saves + gc %}
                            {% if total > 0 %}
                            <span class="fw-bold">{{ ((saves / total) * 100) | round(1) }}%</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td colspan="8" class="actions-col d-none">
                            <div class="dropdown text-center goalie-action-dropdown d-none">
                                <button class="btn btn-secondary btn-sm dropdown-toggle w-100" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Actions
                                </button>
                                <div class="dropdown-menu p-2 text-center w-100"
                                    style="min-width: 140px; overflow: visible; max-height: none;">
                                    <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=assist{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-info btn-sm my-1 w-100">+Assist</a>
                                    <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=assist_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-outline-info btn-sm my-1 w-100">-Assist</a>
                                    <hr class="dropdown-divider">
                                    <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=save{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-primary btn-sm my-1 w-100">Save</a>
                                    <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=save_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-outline-primary btn-sm my-1 w-100">-Save</a>
                                    <hr class="dropdown-divider">
                                    <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=goal_conceded{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-danger btn-sm my-1 w-100">Goal Conceded</a>
                                    <a href="/action_goalie/{{ game_id }}/{{ goalie }}?action=goal_conceded_minus{% if request.args.get('edit') == '1' %}&edit=1{% endif %}"
                                        class="btn btn-outline-danger btn-sm my-1 w-100">-Goal Conceded</a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <script>
        // On page load, check for ?edit=1 and show edit mode if present
        document.addEventListener('DOMContentLoaded', function () {
            if (new URLSearchParams(window.location.search).get('edit') === '1') {
                setEditMode(true);
            }
        });
        function setEditMode(on) {
            document.querySelectorAll('.action-dropdown').forEach(el => el.classList.toggle('d-none', !on));
            document.querySelectorAll('.line-action').forEach(el => el.classList.toggle('d-none', !on));
            document.querySelectorAll('.goalie-action-dropdown').forEach(el => el.classList.toggle('d-none', !on));
            document.querySelectorAll('.actions-col').forEach(el => el.classList.toggle('d-none', !on));
        }
        function toggleModify(e) {
            e.preventDefault();
            const params = new URLSearchParams(window.location.search);
            if (params.get('edit') === '1') {
                params.delete('edit');
            } else {
                params.set('edit', '1');
            }
            window.location.search = params.toString();
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>