<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats Overview</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <style>
        th.rotate {
            padding: 10px 2px !important;
            white-space: nowrap;
            vertical-align: bottom;
            text-align: center;
            position: relative;
        }

        th.rotate>div {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            width: auto;
            font-size: 0.85em;
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 2.5rem;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        td,
        th {
            padding: 2px 4px !important;
            vertical-align: middle;
        }

        .table {
            font-size: 0.92em;
            margin-bottom: 0.5rem;
            table-layout: auto;
        }

        .container-custom {
            max-width: 1100px;
            margin-left: auto;
            margin-right: auto;
            padding: 0.5rem 1.5rem;
        }

        h1,
        h3 {
            margin-bottom: 0.7rem !important;
            font-size: 1.2rem;
        }

        form.mb-4 {
            margin-bottom: 0.7rem !important;
        }

        @media (max-width: 991px) {
            .container-custom {
                padding: 0.5rem 0.5rem;
            }
        }
    </style>
    {% macro format_date(date_str) %}
    {%- set d = date_str.split('-') if date_str else None -%}
    {{ d[2] ~ '.' ~ d[1] ~ '.' ~ d[0] if d and d|length == 3 else date_str }}
    {% endmacro %}
</head>

<body>
    <div class="container-custom mt-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0">Stats Overview</h1>
            <a href="/" class="btn btn-secondary btn-sm">Back to Home</a>
        </div>
        <form method="get" class="mb-4">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <label for="team" class="form-label mb-0">Category:</label>
                </div>
                <div class="col-auto">
                    <select class="form-select form-select-sm" id="team" name="team" onchange="this.form.submit()">
                        <option value="">All</option>
                        {% for t in teams %}
                        <option value="{{ t }}" {% if t==selected_team %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
        <h3>Plus/Minus</h3>
        <div class="table-responsive mb-4">
            <table class="table table-bordered align-middle text-center" style="table-layout: auto;">
                <thead>
                    <tr>
                        <th>Player</th>
                        {% for g in games %}
                        <th class="rotate">
                            <div>{{ format_date(g.date) }} - {{ g.home_team }} vs {{ g.away_team }}</div>
                        </th>
                        {% endfor %}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in players %}
                    <tr>
                        <td class="text-start">{{ player }}</td>
                        {% for g in games %}
                        <td>{{ g.plusminus.get(player, 0) }}</td>
                        {% endfor %}
                        <td class="fw-bold">{{ player_totals[player]['plusminus'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <h3>Goals / Assists</h3>
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center" style="table-layout: auto;">
                <thead>
                    <tr>
                        <th>Player</th>
                        {% for g in games %}
                        <th class="rotate">
                            <div>{{ format_date(g.date) }} - {{ g.home_team }} vs {{ g.away_team }}</div>
                        </th>
                        {% endfor %}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in players %}
                    <tr>
                        <td class="text-start">{{ player }}</td>
                        {% for g in games %}
                        <td>{{ g.goals.get(player, 0) }} + {{ g.assists.get(player, 0) }}</td>
                        {% endfor %}
                        <td class="fw-bold">
                            {{ player_totals[player]['goals'] }} + {{ player_totals[player]['assists'] }} = {{
                            player_totals[player]['goals'] + player_totals[player]['assists'] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if goalies or (opponent_goalie_data.total_saves > 0 or opponent_goalie_data.total_goals_conceded > 0) %}
        <h3>Goalie Save Percentages</h3>
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center" style="table-layout: auto;">
                <thead>
                    <tr>
                        <th>Goalie</th>
                        {% for g in games %}
                        <th class="rotate">
                            <div>{{ format_date(g.date) }} - {{ g.home_team }} vs {{ g.away_team }}</div>
                        </th>
                        {% endfor %}
                        <th>Average</th>
                    </tr>
                </thead>
                <tbody>
                    {% for goalie in goalies %}
                    <tr>
                        <td class="text-start">{{ goalie }}</td>
                        {% for g in games %}
                        <td>
                            {% set save_pct = g.save_percentages.get(goalie) %}
                            {% if save_pct is not none %}
                                {{ "%.1f"|format(save_pct) }}%
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="fw-bold">
                            {% set avg_pct = goalie_data[goalie]['average_save_percentage'] %}
                            {% if avg_pct is not none %}
                                {{ "%.1f"|format(avg_pct) }}%
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if opponent_goalie_data.total_saves > 0 or opponent_goalie_data.total_goals_conceded > 0 %}
                    <tr>
                        <td class="text-start">Opponent Goalie</td>
                        {% for g in games %}
                        <td>
                            {% if g.get('opponent_goalie_enabled', false) %}
                                {% set opponent_save_pct = g.opponent_save_percentage %}
                                {% if opponent_save_pct is not none %}
                                    {{ "%.1f"|format(opponent_save_pct) }}%
                                {% else %}
                                    -
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="fw-bold">
                            {% set opponent_avg_pct = opponent_goalie_data['average_save_percentage'] %}
                            {% if opponent_avg_pct is not none %}
                                {{ "%.1f"|format(opponent_avg_pct) }}%
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</body>

</html>