{% extends "base.html" %}

{% block title %}{{ g.t['roster'] }}{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ g.t['roster_management'] }}</h1>

    {% if not selected_category %}
    <!-- Season Selector -->
    <div class="mb-4">
        <form method="get" class="d-flex gap-2 align-items-center">
            <label for="seasonSelect" class="fw-bold">{{ g.t['season'] }}:</label>
            <select class="form-select" style="width: auto; min-width: 200px;" id="seasonSelect" name="season" onchange="this.form.submit()">
                <option value="">{{ g.t['all_seasons'] }}</option>
                {% for season in all_seasons %}
                <option value="{{ season }}" {% if season==selected_season %}selected{% endif %}>{{ season }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- Show existing rosters as clickable cards -->
    <div class="mb-4">
        <h4>{{ g.t['select_roster'] }}</h4>
        <div class="row">
            {% for roster_cat in existing_rosters %}
            <div class="col-md-3 mb-3">
                <a href="{{ url_for('roster_list', category=roster_cat, season=selected_season) }}" class="btn btn-outline-primary w-100 p-3"
                    style="font-size: 1.2rem;">
                    {{ roster_cat }}
                </a>
            </div>
            {% endfor %}
        </div>
        {% if not existing_rosters %}
        <div class="alert alert-info">{{ g.t['no_players'] }}</div>
        {% endif %}
    </div>

    <!-- Create New Roster Button -->
    <div class="mb-4">
        <h4>Create New Roster</h4>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newRosterModal">
            + Create New Roster
        </button>
    </div>

    <!-- Modal for creating new roster -->
    <div class="modal fade" id="newRosterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Roster</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newRosterForm">
                        <div class="mb-3">
                            <label for="newSeasonName" class="form-label">{{ g.t['season_name'] }}</label>
                            <input type="text" class="form-control" id="newSeasonName"
                                placeholder="e.g., 2024-25, Fall 2024" required>
                        </div>
                        <div class="mb-3">
                            <label for="newCategoryName" class="form-label">Roster Name/Category</label>
                            <input type="text" class="form-control" id="newCategoryName"
                                placeholder="e.g., U18, Senior, NLA" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ g.t['cancel'] }}</button>
                    <button type="button" class="btn btn-primary" onclick="createNewRoster()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function createNewRoster() {
            const seasonName = document.getElementById('newSeasonName').value.trim();
            const categoryName = document.getElementById('newCategoryName').value.trim();
            if (seasonName && categoryName) {
                window.location.href = '{{ url_for("roster_list") }}?season=' + encodeURIComponent(seasonName) + '&category=' + encodeURIComponent(categoryName);
            }
        }

        // Allow Enter key to submit
        document.getElementById('newSeasonName')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('newCategoryName').focus();
            }
        });
        document.getElementById('newCategoryName')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                createNewRoster();
            }
        });
    </script>

    {% else %}
    <!-- Viewing a specific roster -->
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <h3 class="mb-0">{{ g.t['roster'] }}: {% if selected_season %}{{ selected_season }} - {% endif %}{{ selected_category }}</h3>
        <div>
            <button type="button" class="btn btn-outline-danger me-2" onclick="deleteEntireRoster()">
                üóëÔ∏è Delete Roster
            </button>
            <a href="{{ url_for('roster_list', season=selected_season) }}" class="btn btn-secondary">‚Üê Back to Rosters</a>
        </div>
    </div>

    <div class="mb-3">
        <a href="{{ url_for('roster_add', category=selected_category, season=selected_season) }}" class="btn btn-primary">{{ g.t['add_player']
            }}</a>
        <a href="{{ url_for('roster_bulk_import', category=selected_category, season=selected_season) }}" class="btn btn-success">{{
            g.t['bulk_import'] }}</a>
        <button type="button" class="btn btn-danger" id="bulkDeleteBtn" style="display:none;"
            onclick="bulkDeletePlayers()">
            Delete Selected
        </button>
    </div>

    {% if roster %}
    <form id="bulkDeleteForm">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="rosterTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
                        <th class="sortable" onclick="sortTable(1)" style="cursor: pointer;">{{ g.t['number'] }} <span class="sort-icon"></span></th>
                        <th class="sortable" onclick="sortTable(2)" style="cursor: pointer;">{{ g.t['surname'] }} <span class="sort-icon"></span></th>
                        <th class="sortable" onclick="sortTable(3)" style="cursor: pointer;">{{ g.t['name'] }} <span class="sort-icon"></span></th>
                        <th class="sortable" onclick="sortTable(4)" style="cursor: pointer;">{{ g.t['nickname'] }} <span class="sort-icon"></span></th>
                        <th class="sortable" onclick="sortTable(5)" style="cursor: pointer;">{{ g.t['position'] }} <span class="sort-icon"></span></th>
                        <th class="sortable" onclick="sortTable(6)" style="cursor: pointer;">{{ g.t['tesser'] }} <span class="sort-icon"></span></th>
                        <th>{{ g.t['actions'] }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in roster %}
                    <tr>
                        <td><input type="checkbox" name="player_ids" value="{{ player.id }}" class="player-checkbox"
                                onchange="updateBulkDeleteBtn()"></td>
                        <td>{{ player.number }}</td>
                        <td>{{ player.surname }}</td>
                        <td>{{ player.name }}</td>
                        <td>{{ player.nickname }}</td>
                        <td>
                            {% if player.position == 'A' %}{{ g.t['position_a'] }}
                            {% elif player.position == 'C' %}{{ g.t['position_c'] }}
                            {% elif player.position == 'D' %}{{ g.t['position_d'] }}
                            {% elif player.position == 'P' %}{{ g.t['position_p'] }}
                            {% endif %}
                        </td>
                        <td>{{ player.tesser }}</td>
                        <td>
                            <a href="{{ url_for('roster_edit', player_id=player.id, category=selected_category, season=selected_season) }}"
                                class="btn btn-sm btn-warning">{{
                                g.t['edit_player'] }}</a>
                            <a href="{{ url_for('roster_delete', player_id=player.id, category=selected_category, season=selected_season) }}"
                                class="btn btn-sm btn-danger" data-confirm="{{ g.t['delete_confirm'] }}">{{
                                g.t['delete_player'] }}</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

    <style>
        .sortable {
            position: relative;
            padding-right: 20px !important;
        }
        .sort-icon::after {
            content: '‚áÖ';
            position: absolute;
            right: 5px;
            opacity: 0.3;
        }
        .sort-icon.asc::after {
            content: '‚Üë';
            opacity: 1;
        }
        .sort-icon.desc::after {
            content: '‚Üì';
            opacity: 1;
        }
    </style>

    <script>
        let sortDirection = {};

        function sortTable(columnIndex) {
            const table = document.getElementById('rosterTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Toggle sort direction
            sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
            const isAsc = sortDirection[columnIndex] === 'asc';
            
            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.cells[columnIndex].textContent.trim();
                const bCell = b.cells[columnIndex].textContent.trim();
                
                // Try to parse as number first
                const aNum = parseFloat(aCell);
                const bNum = parseFloat(bCell);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAsc ? aNum - bNum : bNum - aNum;
                }
                
                // String comparison
                return isAsc ? aCell.localeCompare(bCell) : bCell.localeCompare(aCell);
            });
            
            // Reorder table
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'sort-icon';
            });
            const currentHeader = table.querySelector(`thead th:nth-child(${columnIndex + 1}) .sort-icon`);
            if (currentHeader) {
                currentHeader.className = `sort-icon ${isAsc ? 'asc' : 'desc'}`;
            }
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.player-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkDeleteBtn();
        }

        function updateBulkDeleteBtn() {
            const checkedBoxes = document.querySelectorAll('.player-checkbox:checked');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            if (checkedBoxes.length > 0) {
                bulkDeleteBtn.style.display = 'inline-block';
                bulkDeleteBtn.textContent = `Delete Selected (${checkedBoxes.length})`;
            } else {
                bulkDeleteBtn.style.display = 'none';
            }
        }

        function bulkDeletePlayers() {
            const checkedBoxes = document.querySelectorAll('.player-checkbox:checked');
            if (checkedBoxes.length === 0) return;

            if (!confirm(`Are you sure you want to delete ${checkedBoxes.length} player(s)?`)) {
                return;
            }

            const playerIds = Array.from(checkedBoxes).map(cb => cb.value);

            // Send delete request
            fetch('{{ url_for("roster_bulk_delete") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: '{{ selected_category }}',
                    season: '{{ selected_season }}',
                    player_ids: playerIds
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error deleting players: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error);
                });
        }
    </script>

    {% else %}
    <div class="alert alert-info">{{ g.t['no_players'] }}</div>
    {% endif %}

    <script>
        function deleteEntireRoster() {
            const category = '{{ selected_category }}';

            if (!confirm(`Are you sure you want to delete the entire "${category}" roster?\n\nThis will permanently delete all players in this roster.`)) {
                return;
            }

            // First attempt - check for warnings
            fetch('{{ url_for("delete_roster") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: category,
                    force: false
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Successfully deleted
                        alert('Roster deleted successfully');
                        window.location.href = '{{ url_for("roster_list") }}';
                    } else if (data.warning) {
                        // Warning about existing games
                        if (confirm(data.message + '\n\nDo you want to proceed with deletion?')) {
                            // User confirmed, delete with force
                            fetch('{{ url_for("delete_roster") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    category: category,
                                    force: true
                                })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        alert('Roster deleted successfully');
                                        window.location.href = '{{ url_for("roster_list") }}';
                                    } else {
                                        alert('Error: ' + data.error);
                                    }
                                })
                                .catch(error => alert('Error: ' + error));
                        }
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error);
                });
        }
    </script>
    {% endif %}

    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">{{ g.t['back_to_home'] }}</a>
</div>
{% endblock %}